<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Power Consumption Visualization</title>
  <link rel="stylesheet" type="text/css" href="/css" />
  <link rel="stylesheet" type="text/css" href="/css/prime-ui" />
  
  <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
  <script src="/js/prime-ui"></script>
  <script src="/js/pianobar"></script>
  <script>
  var circuitNameToIndex = {"c1":0, "c2":1, "c3":2, "c4":3, "c5":4, "c6":5, "c7a":6, "c7b":7, "c8":8, "c9":9, "c10":10, "c11":11, "c12":12, "c13":13, "c14":14, "c15":15, "c16":16, "c17":17, "c18":18, "c19":19, "c20": 20};	
  var selectedCircuits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
  var indexToName = ["c1", "c2", "c3", "c4", "c5", "c6", "c7a", "c7b", "c8", "c9", "c10", "c11", "c12", "c13", "c14", "c15", "c16", "c17", "c18", "c19", "c20"];
  var maxCircuitValue = 0;
  var dateRange;
  var powerEvents;
  var overviewStartDate, overviewEndDate, zoomStartDate, zoomEndDate;
      
  $.getJSON("/data/circuitMax").done(function(data){
  		$.each(data[0], function (i, d){
  			maxCircuitValue = Math.max(d, maxCircuitValue);
  		});
  		$.getJSON("/data/dateBounds").done(function(dateData){
  			dateRange = {
  				start: new Date(dateData.start),
  				end : new Date(dateData.end)
  			};
  			
  			//initialize date range widgets
  			$(document).ready( function(){  				
  				$("#startDate").datepicker({
  					minDate: dateRange.start,
  					maxDate: dateRange.end,
  					onClose: function( selectedDate ) {
  						$( "#endDate" ).datepicker( "option", "minDate", selectedDate !== "" ? selectedDate : dateRange.start);
  						overviewStartDate = new Date(selectedDate);
  					}
  				});
  		  	  	$("#endDate").datepicker({
  		  	  		minDate: dateRange.start,
					maxDate: dateRange.end,
					onClose: function( selectedDate ) {
  						$( "#startDate" ).datepicker( "option", "maxDate", selectedDate !== "" ? selectedDate : dateRange.end);
  						overviewEndDate = new Date(selectedDate);
  					}
  		  	  	});
  		  	  	overviewStartDate = $("#startDate").datepicker("getDate");
  		  		overviewEndDate = $("#endDate").datepicker("getDate");
  			});
  	  	});
  	});
  	
  
  	function loadEvents(start, end, selectedCircuits)
  	{
  		$.getJSON("/data/powerEvents/" + selectedCircuits.join(",") + "/" + start.getTime() + "/" + end.getTime() ).done(function(events)
	  	{
  			powerEvents = events;
  			zoomStartDate = overviewStartDate;
  			zoomEndDate = overviewEndDate;
  			drawOverview(events, overviewStartDate, overviewEndDate);
  			drawZoomView(events, zoomStartDate, zoomEndDate);
  			$("#loading").puidialog("hide");
	  	});	
  	}
  	
  	function getColor(value){
  	    //value from 0 to 1
  	    if(value < 0.01)
  	    {
  	    	return "#000";
  	    }
  	    var hue=((1-value)*120).toString(10);
  	    return ["hsl(",hue,",100%,50%)"].join("");
  	}
  	
  	
  	$(document).ready( function(){
  		$("#circuitSelector").puidialog();
  		$("#loading").puidialog({modal: true});
  		$("#circuitSelector input").puicheckbox();
  		$("#load").button().click(function(){
  			if(overviewStartDate && overviewEndDate && selectedCircuits.length > 0)
  			{
  				$("#loading").puidialog("show");
  				loadEvents(overviewStartDate, overviewEndDate, selectedCircuits);
  			}
  		});
  		$("#selectCircuits").button().click(function(){
  			$("#circuitSelector").puidialog("show");
  		});
  	});
  	
  </script>
</head>
<body>

<div id="visualizationContainer">
    <div id="visTopContainer">
        <div id="circuitGraph">
            
        </div>
        <div id="circuitLevels">
            
        </div>
        <div id="circuitQuery">
        </div>
    </div>
    <div id="visBottomContainer">
        <div id="overviewContainer">
            <div id="options">
				Start Date: <input type="text" id="startDate" /><br/>
				End Date: <input type="text" id="endDate" />
            </div>
            <div id="overview">
            	<canvas id="overviewBackground"></canvas>
            	<svg id="overviewScrollbar"></svg>
            </div>
        </div>
        <div id="zoomContainer">
            <div id="labels">
            	<button id="load">Load</button>
            	<br/>
            	<button id="selectCircuits">Show/Hide Circuits</button>
            </div>
            <div id="zoomViewContainer">
            	<svg id="zoomView"></svg>
            </div>
        </div>
    </div>
</div>

<div id="circuitSelector">
	<input type="checkbox" value="0" checked="checked" /> Circuit 1 <br/>
	<input type="checkbox" value="1" checked="checked" /> Circuit 2 <br/>
	<input type="checkbox" value="2" checked="checked" /> Circuit 3 <br/>
	<input type="checkbox" value="3" checked="checked" /> Circuit 4 <br/>
	<input type="checkbox" value="4" checked="checked" /> Circuit 5 <br/>
	<input type="checkbox" value="5" checked="checked" /> Circuit 6 <br/>
	<input type="checkbox" value="6" checked="checked" /> Circuit 7A <br/>
	<input type="checkbox" value="7" checked="checked" /> Circuit 7B <br/>
	<input type="checkbox" value="8" checked="checked" /> Circuit 8 <br/>
	<input type="checkbox" value="9" checked="checked" /> Circuit 9 <br/>
	<input type="checkbox" value="10" checked="checked" /> Circuit 10 <br/>
	<input type="checkbox" value="11" checked="checked" /> Circuit 11 <br/>
	<input type="checkbox" value="12" checked="checked" /> Circuit 12 <br/>
	<input type="checkbox" value="13" checked="checked" /> Circuit 13 <br/>
	<input type="checkbox" value="14" checked="checked" /> Circuit 14 <br/>
	<input type="checkbox" value="15" checked="checked" /> Circuit 15 <br/>
	<input type="checkbox" value="16" checked="checked" /> Circuit 16 <br/>
	<input type="checkbox" value="17" checked="checked" /> Circuit 17 <br/>
	<input type="checkbox" value="18" checked="checked" /> Circuit 18 <br/>
	<input type="checkbox" value="19" checked="checked" /> Circuit 19 <br/>
	<input type="checkbox" value="20" checked="checked" /> Circuit 20
</div>

<div id="loading">
	Loading...
</div>

</body>
</html>
