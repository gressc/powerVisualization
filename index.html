<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Power Consumption Visualization</title>
  <link rel="stylesheet" type="text/css" href="/css" />
  <link rel="stylesheet" type="text/css" href="/css/prime-ui" />
  
  <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
  <script src="/js/prime-ui"></script>
  <script>
  var circuitNameToIndex = {"c1":0, "c2":1, "c3":2, "c4":3, "c5":4, "c6":5, "c7a":6, "c7b":7, "c8":8, "c9":9, "c10":10, "c11":11, "c12":12, "c13":13, "c14":14, "c15":15, "c16":16, "c17":17, "c18":18, "c19":19, "c20": 20};	
  var selectedCircuits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
  var indexToName = ["c1", "c2", "c3", "c4", "c5", "c6", "c7a", "c7b", "c8", "c9", "c10", "c11", "c12", "c13", "c14", "c15", "c16", "c17", "c18", "c19", "c20"];
  var maxCircuitValue = 0;
  var powerEvents;
  
  var leftHandle, rightHandle, scroll;
  
  var leftHandleDrag = d3.behavior.drag()
  	.on("drag", dragLeftHandle);
  var rightHandleDrag = d3.behavior.drag()
  	.on("drag", dragRightHandle);
  var scrollDrag = d3.behavior.drag()
  .origin(function(d) { return d; })
	.on("drag", dragScroll);
  
  	$.getJSON("/data/circuitMax").done(function(data){
  		$.each(data[0], function (i, d){
  			maxCircuitValue = Math.max(d, maxCircuitValue);
  		});
  	}).then(function(data){
  		$.getJSON("/data/powerEvents").done(function(events)
	  	{
  			powerEvents = events;
  			drawOverview(events);
  			drawZoomView(events, new Date(events[0].start), new Date(events[events.length - 1].end));
	  	});	
  	});
  	
  	function getColor(value){
  	    //value from 0 to 1
  	    if(value < 0.01)
  	    {
  	    	return "#000";
  	    }
  	    var hue=((1-value)*120).toString(10);
  	    return ["hsl(",hue,",100%,50%)"].join("");
  	}
  	
  	function drawZoomView(events, start, end)
  	{
  		var rangeInMilliseconds = end.getTime() - start.getTime();
  		var svgBox = document.getElementById("zoomView").getBoundingClientRect();
  		var svg = d3.select("#zoomView");
  		
  		svg.append("g")
  		.attr("class", "eventContainer")
  		.selectAll("rect.event")
  		.data(events).enter()
  		.append("rect")
  		.attr("class", "event")
  		.attr("x", function(d){ return (new Date(d.start).getTime() - start.getTime()) / rangeInMilliseconds * svgBox.width;})
  		.attr("y", function(d){ return circuitNameToIndex[d.circuit] * (svgBox.height / selectedCircuits.length);})
  		.attr("width", function(d){ return (new Date(d.end).getTime() - new Date(d.start).getTime()) / rangeInMilliseconds * svgBox.width})
  		.attr("height", function(d){ return svgBox.height / selectedCircuits.length;})
  		.attr("data-start", function(d){ return d.start;})
  		.attr("data-end", function(d){ return d.end;})
  		.attr("avgKW", function(d){ return d.avgKW;})
  		.attr("fill", function(d){
  			return getColor(d.avgKW / maxCircuitValue);
  		});
  		
  		var labels = d3.select("#labels").append("svg")
  		.attr("width", document.getElementById("labels").clientWidth)
  		.attr("height", document.getElementById("labels").clientHeight)
  		.selectAll("text")
  		.data(selectedCircuits).enter()
  		.append("text")
  		.attr("x", function (d){ return document.getElementById("labels").clientWidth;})
  		.attr("y", function (d){ return ((d + 1) * svgBox.height / selectedCircuits.length);})  		
  		.attr("text-anchor", "end")
  		.attr("font-size", function(d) {return (svgBox.height / selectedCircuits.length) + "px"; })
  		.text(function(d) {return indexToName[d]});
  	}
  	
  	function drawOverview(events)
  	{
  		var startTimeRange = new Date(events[0].start);
  		var endTimeRange = new Date(events[events.length - 1].end);
  		var rangeInMilliseconds = endTimeRange.getTime() - startTimeRange.getTime();
  		
  		var canvas = document.getElementById("overviewBackground");
  		var container = canvas.parentNode.getBoundingClientRect();
  		
  		canvas.width = container.width;
  		canvas.height = container.height; 
  		var context = canvas.getContext("2d");

  		$.each(events, function(i, d){
  			var x = ((new Date(d.start).getTime() - startTimeRange.getTime()) / rangeInMilliseconds) * canvas.width;
  			var y = circuitNameToIndex[d.circuit] * (canvas.height / selectedCircuits.length);
  			var w = ((new Date(d.end).getTime() - new Date(d.start).getTime()) / rangeInMilliseconds) * canvas.width;
  			var h = (canvas.height / selectedCircuits.length);
  			context.fillStyle = getColor(d.avgKW / maxCircuitValue);
  	  		context.fillRect(x,y,w,h);
  		});
  		  		
  		drawScrollbar(canvas.width, canvas.height);
  	}
  	
  	function drawScrollbar(width, height)
  	{
  		var svgElement = document.getElementById("overviewScrollbar");
  		svgElement.setAttribute("viewBox", "0 0 " + width + " " + height);
  		svgElement.setAttribute("preserveAspectRatio", "xminymin")
  		
		var scrollbar = d3.select("#overviewScrollbar").append("g").attr("class", "scroll");
  		
  		scroll = scrollbar.append("rect")
  		.attr("x", "0")
  		.attr("y", "0")
  		.attr("width", width)
  		.attr("height", height)
  		.call(scrollDrag);
  		
  		leftHandle = scrollbar.append("g")
  		.attr("class", "left-handle")
  		.attr("transform", "translate(0,0)")
  		.append("polygon")
  		.attr("points", "0,0 0," + height + " 10," + height + " 10," + (height - 5) + " 5," + (height - 5) + " 5,5 10,5 10,0")
  		.call(leftHandleDrag);
  		
  		rightHandle = scrollbar.append("g")
  		.attr("class", "right-handle")
  		.attr("transform", "translate(" + width + ",0)")
  		.append("polygon")
  		.attr("points", "-10,0 0,0 0," + height + " -10," + height + " -10," + (height - 5) + " -5," + (height - 5) + " -5,5 -10,5")
  		.call(rightHandleDrag);
  	}
  	
  	function dragLeftHandle(d)
  	{
  		if(d3.event.x >= 0 && d3.event.x <= document.getElementById("overviewBackground").width)
  		{
  			leftHandle.attr("transform", "translate(" + d3.event.x + ", 0)");
  			
  			scroll.attr("x", d3.event.x)
  			.attr("width", function(d) { 
  				this.width + d3.event.x;
  			});
  		}
  			
  	}
  	
  	function dragRightHandle(d)
  	{
  		/*d3.select(this)
        .attr("cx", d.x = Math.max(radius, Math.min(width - radius, d3.event.x)))
        .attr("cy", d.y = Math.max(radius, Math.min(height - radius, d3.event.y)));*/
  	}
  	
  	function dragScroll(d)
  	{
  		/*d3.select(this)
        .attr("cx", d.x = Math.max(radius, Math.min(width - radius, d3.event.x)))
        .attr("cy", d.y = Math.max(radius, Math.min(height - radius, d3.event.y)));*/
  	}
  	
  	function transformZoomView(scaleFactor, translate)
  	{
  		$("#zoomView g").attr("transform","scale(" + scaleFactor + ",1) translate( " + translate + ", 0)");
  	}
  	
  	$(document).ready( function(){
  		$("#circuitSelector").puidialog();
  		$("#circuitSelector input").puicheckbox();
  		$("#startDate").datepicker();
  	  	$("#endDate").datepicker();
  	});
  	
  </script>
</head>
<body>

<div id="visualizationContainer">
    <div id="visTopContainer">
        <div id="circuitGraph">
            
        </div>
        <div id="circuitLevels">
            
        </div>
        <div id="circuitQuery">
        </div>
    </div>
    <div id="visBottomContainer">
        <div id="overviewContainer">
            <div id="options">
				Start Date: <input type="text" id="startDate" /><br/>
				End Date: <input type="text" id="endDate" />
            </div>
            <div id="overview">
            	<canvas id="overviewBackground"></canvas>
            	<svg id="overviewScrollbar"></svg>
            </div>
        </div>
        <div id="zoomContainer">
            <div id="labels">
            </div>
            <div id="zoomViewContainer">
            	<svg id="zoomView"></svg>
            </div>
        </div>
    </div>
</div>

<div id="circuitSelector">
	<input type="checkbox" value="0" /> Circuit 1
	<input type="checkbox" value="1" /> Circuit 2
	<input type="checkbox" value="2" /> Circuit 3
	<input type="checkbox" value="3" /> Circuit 4
	<input type="checkbox" value="4" /> Circuit 5
	<input type="checkbox" value="5" /> Circuit 6
	<input type="checkbox" value="6" /> Circuit 7A
	<input type="checkbox" value="7" /> Circuit 7B
	<input type="checkbox" value="8" /> Circuit 8
	<input type="checkbox" value="9" /> Circuit 9
	<input type="checkbox" value="10" /> Circuit 10
	<input type="checkbox" value="11" /> Circuit 11
	<input type="checkbox" value="12" /> Circuit 12
	<input type="checkbox" value="13" /> Circuit 13
	<input type="checkbox" value="14" /> Circuit 14
	<input type="checkbox" value="15" /> Circuit 15
	<input type="checkbox" value="16" /> Circuit 16
	<input type="checkbox" value="17" /> Circuit 17
	<input type="checkbox" value="18" /> Circuit 18
	<input type="checkbox" value="19" /> Circuit 19
	<input type="checkbox" value="20" /> Circuit 20
</div>

</body>
</html>
